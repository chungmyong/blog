<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>책먹보심선생의 블로그 글감 추천기</title>
    <!-- Tailwind CSS를 사용해 깔끔한 스타일을 적용합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-100">

    <!-- 메인 컨테이너 -->
    <div class="bg-white p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-lg text-center border-2 border-gray-200">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800">책먹보심선생의 블로그 글감 추천기</h1>
        <p class="text-gray-600 mb-8">
            블로그에 쓸 주제나 키워드를 입력해주세요.
        </p>

        <!-- 입력 영역 -->
        <div class="mb-6">
            <textarea
                id="keywordInput"
                class="w-full h-24 p-4 text-gray-800 bg-gray-100 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-indigo-500 transition-colors resize-none"
            ></textarea>
            <p id="error-message" class="hidden text-red-500 text-sm mt-2 text-left">주제나 키워드를 입력해주세요.</p>
        </div>

        <!-- 버튼 영역 -->
        <button
            id="generateButton"
            class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:bg-indigo-400 disabled:cursor-not-allowed"
        >
            글감 추천 받기
        </button>

        <!-- 결과 표시 및 로딩 메시지 영역 -->
        <div id="resultsContainer" class="mt-8 text-left">
            <!-- 로딩 메시지 -->
            <div id="loadingMessage" class="hidden text-center text-gray-500 animate-pulse">
                글감과 목차를 생성하는 중입니다... 잠시만 기다려주세요.
            </div>
            <!-- 결과 표시 -->
            <div id="ideasList" class="space-y-6"></div>
        </div>
    </div>

    <script type="module">
        const keywordInput = document.getElementById('keywordInput');
        const generateButton = document.getElementById('generateButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const ideasList = document.getElementById('ideasList');
        const errorMessage = document.getElementById('error-message');

        const placeholderExamples = [
            '예시: \'커피의 역사\'',
            '예시: \'새로운 기술 트렌드\'',
            '예시: \'건강한 식단\''
        ];

        function setRandomPlaceholder() {
            const randomIndex = Math.floor(Math.random() * placeholderExamples.length);
            keywordInput.placeholder = placeholderExamples[randomIndex];
        }

        setRandomPlaceholder();

        const apiKey = "AIzaSyAokiNnSCdD5b79qqWU9R8ZAyLCZ6362DA";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        // 'Enter' 키를 누르면 버튼 클릭 효과를 내는 이벤트 리스너 추가
        keywordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 줄바꿈 기본 동작 방지
                generateButton.click(); // '글감 추천 받기' 버튼 클릭
            }
        });

        generateButton.addEventListener('click', async () => {
            const keyword = keywordInput.value.trim();
            errorMessage.classList.add('hidden');

            if (!keyword) {
                errorMessage.classList.remove('hidden');
                return;
            }

            generateButton.disabled = true;
            loadingMessage.classList.remove('hidden');
            ideasList.innerHTML = '';

            try {
                const prompt = `"${keyword}"에 대한 블로그 글감 5가지를 추천하고, 각 글감에 대한 간단한 목차를 3~4개 항목으로 포함하여 JSON 형식으로 응답해주세요.`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                ideas: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            outline: {
                                                type: "ARRAY",
                                                items: { type: "STRING" }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);

                    if (parsedJson.ideas && parsedJson.ideas.length > 0) {
                        ideasList.innerHTML = parsedJson.ideas.map(idea => `
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
                                <h4 class="text-xl font-bold text-gray-800">${idea.title}</h4>
                                <ul class="list-disc list-inside mt-2 text-gray-600 space-y-1">
                                    ${(idea.outline || []).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('');
                    } else {
                        ideasList.innerHTML = `<p class="text-red-500 text-center">글감을 생성하는 데 실패했습니다. 다시 시도해주세요.</p>`;
                    }
                } else {
                    ideasList.innerHTML = `<p class="text-red-500 text-center">글감을 생성하는 데 실패했습니다. 다시 시도해주세요.</p>`;
                }
            } catch (error) {
                console.error('API 호출 중 오류 발생:', error);
                ideasList.innerHTML = `<p class="text-red-500 text-center">오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            } finally {
                generateButton.disabled = false;
                loadingMessage.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
